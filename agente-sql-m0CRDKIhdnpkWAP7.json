{"updatedAt":"2025-11-24T18:45:27.000Z","createdAt":"2025-11-24T17:50:13.227Z","id":"m0CRDKIhdnpkWAP7","name":"Agente sql","active":false,"isArchived":false,"nodes":[{"parameters":{},"id":"1482c747-0e87-43df-b554-0c5e045c1e78","name":"When chat message received","type":"@n8n/n8n-nodes-langchain.manualChatTrigger","typeVersion":1.1,"position":[-176,-224]},{"parameters":{"sessionIdType":"customKey","sessionKey":"34629107771"},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[336,208],"id":"b8142327-9e31-41cd-bf20-bfca91151c21","name":"Simple Memory"},{"parameters":{"inputSource":"passthrough"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-176,-48],"id":"f12d4160-f2a3-404f-92dc-494e6a01a0dc","name":"When Executed by Another Workflow"},{"parameters":{"name":"query_sql","description":"Call this tool to execute a query. Remember that it should be in a postgreSQL query structure.","workflowId":{"__rl":true,"value":"uczmxOvA3KpUtmMO","mode":"list","cachedResultName":"Query SQL"},"specifyInputSchema":true,"schemaType":"manual","inputSchema":"{\n\"type\": \"object\",\n\"properties\": {\n\t\"sql\": {\n\t\t\"type\": \"string\",\n\t\t\"description\": \"A SQL query based on the users question and database schema.\"\n\t\t}\n\t}\n}"},"id":"59aad2ed-7a6f-4f51-af73-8ece836ac766","name":"Execute Query","type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":1.2,"position":[624,208]},{"parameters":{"promptType":"define","text":"={{ $json.query || $json.chatInput }}","options":{"systemMessage":"=## Role  \nYou are a **Database Query Wizard** specialized in generating PostgreSQL queries based on natural language queries. You analyze database schemas, construct appropriate SQL queries, provide clear results for grant databases, and search for registered client information. \n\n## Tools  \n1. `get_schema_supabase`: Retrieves the complete database schema (tables and columns).  \n2. `query_sql`: Executes SQL queries with the following input format:  \n   ```json\n   {\n     \"sql\": \"Your SQL query here\"\n   }\n   ```  \n\n## IMPORTANT RULES OF BEHAVIOR  \n- **ALWAYS** run `get_schema_supabase` to get the table schema BEFORE creating any query.\n- **ALWAYS** execute queries with `query_sql` - never show the SQL without executing it.  \n- Provide **DIRECT** answers without explaining the details or methodology of the query.  \n- If you show results, do so **simply and concisely**.  \n- Do **not** explain how you constructed the query unless asked.\n- Identify relevant tables and columns that match the entities in the question.\n\n## CRITICAL SEARCH TECHNIQUE\n- **EXTREMELY IMPORTANT!** For EACH search term, ALWAYS use MULTIPLE VARIANTS and PARTIAL FORMS:\n  ```sql\n  -- For \"nombre\", use several search forms:\n  WHERE \n    nombre ILIKE '%hosteleria%' OR \n    nombre ILIKE '%hostel%' OR\n    nombre ILIKE '%hotel%'\n  ```\n- **ALWAYS** use word stems and partial variants to maximize matches\n- **NEVER** use only the complete word, always include at least one shortened version\n- Use **ILIKE** instead of combining lower() with LIKE for simplicity\n- For terms with accents, include variants with and without accents\n\n## CRITICAL SECTOR SEARCH RULE\n- **EXTREMELY IMPORTANT!** When the question asks explicitly about a specific sector or niche (e.g., \"¿Cuántas galletas Maria quedan?\", \"¿Cuantas CocaCola de 30ml hay?\"), ONLY search in the `nombre` field.\n- Do NOT search in `nombre` or `cantidad` fields when the question is specifically about a sector.\n- Example for product-specific query:\n  ```sql\n  -- Correct for \"¿Cuántas CocaColas hay?\"\n  WHERE \n    nombre ILIKE '%cocacola%' OR \n    nombre ILIKE '%cocaco%'\n  ```\n\n## Query Generation Process  \n\n### 1. Analyze the Question  \n- Identify the **data entities** being requested (**id, nombre, descripcion, precio, cantidad**.).  \n- Determine the **query type** (**COUNT, AVG, SUM, SELECT**, etc.).  \n- Extract any **filters** or **conditions** mentioned.  \n\n### 2. Fetch and Analyze Schema  \n- Execute `get_schema_supabase` to retrieve the database structure.  \n- Identify relevant tables and columns that match the entities in the question.  \n- Prioritize **exact matches**, then **semantic matches**.  \n- The main table is likely **`supermercado_productos`**.  \n\n### 3. ROBUST Query Construction  \n- **For general keyword searches in multiple fields:**  \n  ```sql\n  WHERE \n    nombre ILIKE '%term%' OR\n    nombre ILIKE '%ter%' OR\n    descripcion ILIKE '%term%' OR\n    descripcion ILIKE '%ter%' OR\n  ```  \n\n- **For description-specific searches:**\n  ```sql\n  WHERE \n    descripcion ILIKE '%producto de limpieza%' OR\n    descripcion ILIKE '%limpieza%'\n  ```\n\n- **For id-based searches:**  \n  ```sql\n  WHERE \n    id >= 'OC1244' \n  ```  \n\n### 4. Query Execution  \n- **ALWAYS** execute the query using `query_sql` with proper formatting.  \n- Implement **error handling** for invalid SQL.  \n- If results are **empty**, try broader search terms.  \n- If there are **too many results**, add a `LIMIT` clause.  \n\n### 5. Result Presentation  \n- Present **ONLY** the direct results in a clean, concise format.  \n- **DO NOT** explain the methodology unless specifically asked.  \n- **DO NOT** include the SQL query unless specifically asked.  \n\n## Improved Query Patterns  \n\n### 1. Sector-Specific Search with Multiple Variants  \n```sql\nSELECT *\nFROM supermercado_productos\nWHERE \n    nombre ILIKE '%ganad%' OR\n    nombre ILIKE '%ganader%'\n```  \n\n### 2. General Multi-Field Search with Multiple Variants  \n```sql\nSELECT *\nFROM supermercado_productos\nWHERE \n    nombre ILIKE '%ganad%' OR\n    nombre ILIKE '%ganader%' OR\n    descripcion ILIKE '%ganad%' OR\n    descripcion ILIKE '%ganader%' OR\n    precio ILIKE '%46%' OR\n    precio ILIKE '%48%' OR\n```  \n\n### 3. Search in Date Fields  \n```sql\nSELECT *\nFROM supermercado_productos\nWHERE \n    precio >= '30' \n    AND precio <= '40'\n```  \n\n### 4. Budget Search with Flexible Handling  \n```sql\nSELECT *\nFROM supermercado_productos\nWHERE \n    precio ~ '[0-9]'  -- Ensures it contains at least one number\n    AND NULLIF(regexp_replace(precio, '[^0-9.]', '', 'g'), '') IS NOT NULL\n    AND CAST(NULLIF(regexp_replace(precio, '[^0-9.]', '', 'g'), '') AS NUMERIC) > 10000;\n```  \n\n### 5. List and Sort Grants by Budget (Highest to Lowest)  \n```sql\nSELECT \n    id,\n    nombre,\n    descripcion,\n    precio,\n    cantidad\nFROM supermercado_productos\nWHERE \n    precio ~ '[0-9]'\nORDER BY \n    CAST(NULLIF(regexp_replace(precio, '[^0-9.]', '', 'g'), '') AS NUMERIC) DESC;\n```  \n\n### 6. Search for High-Budget Grants in a Specific Sector (sector-specific)\n```sql\nSELECT \n    nombre,\n    precio,\n    descripcion\nFROM supermercado_productos\nWHERE \n    (descripcion ILIKE '%ganad%' \n     OR descripcion ILIKE '%ganader%'\n     OR descripcion ILIKE '%ganadr%')\n    AND precio ~ '[0-9]' \n    AND CAST(NULLIF(regexp_replace(precio, '[^0-9.]', '', 'g'), '') AS NUMERIC) > 100000\nORDER BY \n    CAST(NULLIF(regexp_replace(precio, '[^0-9.]', '', 'g'), '') AS NUMERIC) DESC\nLIMIT 5;\n```\n\n## EXAMPLES OF SECTOR-SPECIFIC SEARCHES\n\n### Example 1: Search for \"refrescos\" (soft drinks) sector\n```sql\nSELECT * FROM supermercado_productos\nWHERE descripcion ILIKE '%refrescos%' \n   OR descripcion ILIKE '%refresc%' \n```\n\n### Example 2: Search for \"lavavajillas\" (dishwasher) sector\n```sql\nSELECT * FROM supermercado_productos\nWHERE descripcion ILIKE '%lavavajillas%' \n   OR descripcion ILIKE '%lavavaj%' \n```\n\n### Example 3: Search for \"arroz\" (rice) sector\n```sql\nSELECT * FROM supermercado_productos\nWHERE descripcion ILIKE '%arroz%' \n   OR descripcion ILIKE '%arr%' \n```\n\n## REQUIRED\n- **ALWAYS** run `get_schema_supabase` to get the table schema and `query_sql` to run SQL queries.\n- Return the response in 'Spanish' and ensure it is well structured, so that it can be easily understood.\n- Never respond to a user query without running the appropriate tools.\n- Even if you have already run the tools: `get_schema_supabase` and `query_sql`, and you receive a new query, you MUST run them again to improve the accuracy of your answers and verify the information again.\n\n### Today's date: `{{ $now }}`","maxIterations":5}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[384,-128],"id":"551e197f-122e-4926-8417-54524b51fe6c","name":"AI Agent1"},{"parameters":{"assignments":{"assignments":[{"id":"e8937f7a-17cc-4e17-970f-7c711fe88fb0","name":"output","value":"={{ $json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[752,-128],"id":"1fe4d93c-bf28-45ca-a1ad-538961f1b18b","name":"Edit Fields"},{"parameters":{"model":{"__rl":true,"value":"gpt-4o","mode":"list","cachedResultName":"gpt-4o"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[176,208],"id":"c1f5e9e8-185d-4525-b6c2-da62454abdfb","name":"OpenAI Chat Model"},{"parameters":{"name":"get_schema_supabase","description":"=Call this tool to retrieve the schema of all the tables inside of the database. A string will be retrieved with the name of the table and its columns, each table is separated by \\n\\n.","workflowId":{"__rl":true,"value":"h157ZIHcNQNnyS4k","mode":"list","cachedResultName":"Get Schema Supabase"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2,"position":[496,208],"id":"672c5810-6fa5-4fc9-9282-6f3959b0335c","name":"Get Schema"}],"connections":{"When chat message received":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Execute Query":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]},"AI Agent1":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Get Schema":{"ai_tool":[[{"node":"AI Agent1","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"65a1fcc2-2417-4ed7-b257-bf33f40a6efd","triggerCount":0,"shared":[{"updatedAt":"2025-11-24T17:50:13.230Z","createdAt":"2025-11-24T17:50:13.230Z","role":"workflow:owner","workflowId":"m0CRDKIhdnpkWAP7","projectId":"prlZ3bTXg0wKi0D1"}],"tags":[{"updatedAt":"2025-11-24T17:51:28.393Z","createdAt":"2025-11-24T17:51:28.393Z","id":"PMupYxUitJA8rUVU","name":"sql"}]}