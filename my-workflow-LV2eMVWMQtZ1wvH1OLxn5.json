{"updatedAt":"2026-01-08T12:52:32.471Z","createdAt":"2026-01-08T12:52:32.471Z","id":"LV2eMVWMQtZ1wvH1OLxn5","name":"My workflow","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"executeQuery","query":"SELECT tipo_aviso, id, name, telegram_id, hora_requerida, mensaje, shift_id FROM ( SELECT 'FALTA_ENTRADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de maÃ±ana. Hora prevista: ', s.start_morning) as mensaje, NULL as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_morning, '-00:10:00') AND ADDTIME(s.start_morning, '00:12:00') ) AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'FALTA_ENTRADA_MANANA' AND av.fecha_aviso = CURDATE() ) UNION ALL SELECT 'FALTA_ENTRADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de tarde. Hora prevista: ', s.start_afternoon) as mensaje, NULL as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_afternoon, '-00:10:00') AND ADDTIME(s.start_afternoon, '00:12:00') ) AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'FALTA_ENTRADA_TARDE' AND av.fecha_aviso = CURDATE() ) UNION ALL SELECT 'ENTRADA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada maÃ±ana ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_morning, '-00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'ENTRADA_ANTICIPADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'ENTRADA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada maÃ±ana CON RETRASO. Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.start_morning, sh.clock_in), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'ENTRADA_RETRASADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'ENTRADA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada tarde ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_afternoon, '-00:10:00') AND TIME(sh.clock_in) >= s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'ENTRADA_ANTICIPADA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'ENTRADA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada tarde CON RETRASO. Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.start_afternoon, sh.clock_in), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_afternoon, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'ENTRADA_RETRASADA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'FALTA_SALIDA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de maÃ±ana. Hora prevista: ', s.end_morning) as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) < s.end_morning AND TIME(NOW()) >= ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_morning, '02:00:00') AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'FALTA_SALIDA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'FALTA_SALIDA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de tarde. Hora prevista: ', s.end_afternoon) as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(NOW()) >= ADDTIME(s.end_afternoon, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_afternoon, '02:00:00') AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'FALTA_SALIDA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida maÃ±ana ANTICIPADA. Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, sh.clock_out, s.end_morning), ' min antes') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) < s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_ANTICIPADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado salida maÃ±ana CON RETRASO. Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_morning, sh.clock_out), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_RETRASADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida tarde ANTICIPADA. Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, sh.clock_out, s.end_afternoon), ' min antes') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) < s.end_afternoon AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_ANTICIPADA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado salida tarde CON RETRASO. Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_afternoon, sh.clock_out), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_afternoon AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_RETRASADA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) ) AS avisos ORDER BY tipo_aviso, hora_requerida;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[336,352],"id":"a87cc2ef-e453-452d-a00b-d26fa6cb7d09","name":"comprueba estado","alwaysOutputData":true,"credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"={{ $json.mensaje }} {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[608,352],"id":"b80eba2b-c58b-45d9-97ed-4e53766ae4a5","name":"Send a text message","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"BYsUD2vqRGd1zgnb","name":"Fichar Leon"}}},{"parameters":{"rule":{"interval":[{"triggerAtHour":14,"triggerAtMinute":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,160],"id":"a5ae1cba-0a97-4a6e-bdec-0ad8d386c84c","name":"14:02"},{"parameters":{"rule":{"interval":[{"triggerAtHour":9,"triggerAtMinute":32}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"95652c7f-cbe2-4428-8210-bec912760ab7","name":"9:32"},{"parameters":{"rule":{"interval":[{"triggerAtHour":17,"triggerAtMinute":32}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,576],"id":"f7cac824-b3f0-4e3e-9bc4-35a246e8bdd5","name":"17:32"},{"parameters":{"rule":{"interval":[{"triggerAtHour":20,"triggerAtMinute":2}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,736],"id":"3553203d-d0b5-4cda-96b6-29adf9bcc26d","name":"20:02"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-192,352],"id":"3d2f6bb8-b717-4c09-9212-4bc1d156f714","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"operation":"executeQuery","query":"SELECT u.id, u.name, u.telegram_id, s.dow, CASE WHEN s.id IS NULL THEN 'No tienes horario asignado para hoy.' WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND sh.clock_out IS NULL ) AND ( s.start_morning IS NOT NULL AND TIME(NOW()) >= SUBTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.start_morning ) THEN CONCAT('ðŸ”´ URGENTE: Tienes un fichaje ABIERTO del dÃ­a ANTERIOR sin cerrar. Debes cerrar ese fichaje ANTES de hacer la entrada de hoy. Contacta con el administrador.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) < CURDATE() AND sh.clock_out IS NULL ) THEN CONCAT('ðŸ”´ ERROR: Tienes un fichaje ABIERTO de un dÃ­a ANTERIOR. No puedes fichar hasta que cierres el fichaje anterior. Contacta con el administrador.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_in) < s.start_morning AND TIME(sh.clock_out) < s.end_morning AND TIME(NOW()) < s.end_morning ) THEN CONCAT('âš ï¸ Has CERRADO tu turno de MAÃ‘ANA ANTES de tiempo. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), ' | Salida: ', (SELECT TIME_FORMAT(TIME(clock_out), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL LIMIT 1), '. Horario programado: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' - ', TIME_FORMAT(s.end_morning, '%H:%i')) WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_out) < s.end_afternoon AND TIME(NOW()) < s.end_afternoon ) THEN CONCAT('âš ï¸ Has CERRADO tu turno de TARDE ANTES de tiempo. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), ' | Salida: ', (SELECT TIME_FORMAT(TIME(clock_out), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.start_afternoon LIMIT 1), '. Horario programado: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' - ', TIME_FORMAT(s.end_afternoon, '%H:%i')) WHEN (s.start_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_morning, '14:00:00') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de MAÃ‘ANA. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), '. Por favor, ficha ahora.') WHEN (s.start_morning IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) < s.start_morning )) THEN CONCAT('â„¹ï¸ Fichaste ANTES de tiempo la entrada de maÃ±ana. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), '. Turno ABIERTO.') WHEN (s.start_morning IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:15:00') )) THEN CONCAT('âš ï¸ Fichaste TARDE la entrada de maÃ±ana. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), '. Turno ABIERTO.') WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) >= s.end_morning AND TIME(NOW()) <= IFNULL(s.start_afternoon, TIME(NOW())) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_in IS NOT NULL )) THEN CONCAT('ðŸ”´ ERROR: No puedes fichar la SALIDA sin haber fichado la ENTRADA. Contacta con el administrador.') WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) <= IFNULL(s.start_afternoon, '23:59:59') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de MAÃ‘ANA. Hora programada: ', TIME_FORMAT(s.end_morning, '%H:%i'), '. Por favor, ficha la salida ahora.') WHEN (s.start_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_afternoon, '20:00:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL ) AND NOT EXISTS ( SELECT 1 FROM shifts sh2 WHERE sh2.user_id = u.id AND DATE(sh2.clock_in) = CURDATE() AND TIME(sh2.clock_in) >= s.start_afternoon )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de TARDE. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), '. Por favor, ficha ahora.') WHEN (s.start_afternoon IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) < s.start_afternoon )) THEN CONCAT('â„¹ï¸ Fichaste ANTES de tiempo la entrada de tarde. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), '. Turno ABIERTO.') WHEN (s.start_afternoon IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) > ADDTIME(s.start_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ Fichaste TARDE la entrada de tarde. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), '. Turno ABIERTO.') WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) >= s.end_afternoon AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon ) AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL )) THEN CONCAT('ðŸ”´ ERROR: No puedes fichar la SALIDA de tarde sin haber fichado la ENTRADA de tarde. Contacta con el administrador.') WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de TARDE. Hora programada: ', TIME_FORMAT(s.end_afternoon, '%H:%i'), '. Por favor, ficha la salida ahora.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND ( (s.end_morning IS NOT NULL AND s.start_afternoon IS NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00')) OR (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00')) ) ) THEN CONCAT('ðŸ”´ Turno ABIERTO fuera de horario. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL LIMIT 1), ' | Hora programada de salida: ', CASE WHEN s.start_afternoon IS NULL THEN TIME_FORMAT(s.end_morning, '%H:%i') ELSE TIME_FORMAT(s.end_afternoon, '%H:%i') END, '. Por favor, cierra el fichaje ahora.') ELSE NULL END AS mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = WEEKDAY(NOW()) + 1 WHERE u.active = 1 AND u.telegram_id IS NOT NULL;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[144,928],"id":"5b980ac0-01cd-4d24-841e-6913f27180d2","name":"comprueba estado1","alwaysOutputData":true,"credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}},"disabled":true},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"={{ $json.mensaje }} {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[384,928],"id":"42e2d771-42aa-489b-8aae-931ce5e3c454","name":"Send a text message1","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"BYsUD2vqRGd1zgnb","name":"Fichar Leon"}},"disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT u.id as user_id, u.name as user_name, u.telegram_id, s.dow, s.start_morning, s.end_morning, s.start_afternoon, s.end_afternoon, TIME(NOW()) as hora_actual, 'Test de campos' as mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = DAYOFWEEK(NOW()) -1 WHERE u.active = 1 AND u.telegram_id IS NOT NULL LIMIT 3;\n","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[400,720],"id":"90da53bd-a4ac-46a1-9e33-7a25c91e5cf9","name":"test de horarios","credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT u.id, u.name, u.telegram_id, s.dow, CASE WHEN s.id IS NULL THEN 'No tienes horario asignado para hoy.' WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) AND sh.clock_out IS NULL ) AND ( s.start_morning IS NOT NULL AND TIME(NOW()) >= SUBTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.start_morning ) THEN CONCAT('ðŸ”´ URGENTE: Tienes un fichaje ABIERTO del dÃ­a ANTERIOR sin cerrar. Debes cerrar ese fichaje ANTES de hacer la entrada de hoy. Contacta con el administrador.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) < CURDATE() AND sh.clock_out IS NULL ) THEN CONCAT('ðŸ”´ ERROR: Tienes un fichaje ABIERTO de un dÃ­a ANTERIOR. No puedes fichar hasta que cierres el fichaje anterior. Contacta con el administrador.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_in) < s.start_morning AND TIME(sh.clock_out) < s.end_morning AND TIME(NOW()) < s.end_morning ) THEN CONCAT('âš ï¸ Has CERRADO tu turno de MAÃ‘ANA ANTES de tiempo. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), ' | Salida: ', (SELECT TIME_FORMAT(TIME(clock_out), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL LIMIT 1), '. Horario programado: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' - ', TIME_FORMAT(s.end_morning, '%H:%i')) WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_out) < s.end_afternoon AND TIME(NOW()) < s.end_afternoon ) THEN CONCAT('âš ï¸ Has CERRADO tu turno de TARDE ANTES de tiempo. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), ' | Salida: ', (SELECT TIME_FORMAT(TIME(clock_out), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.start_afternoon LIMIT 1), '. Horario programado: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' - ', TIME_FORMAT(s.end_afternoon, '%H:%i')) WHEN (s.start_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_morning, '14:00:00') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de MAÃ‘ANA. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), '. Por favor, ficha ahora.') WHEN (s.start_morning IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) < s.start_morning )) THEN CONCAT('â„¹ï¸ Fichaste ANTES de tiempo la entrada de maÃ±ana. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), '. Turno ABIERTO.') WHEN (s.start_morning IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:15:00') )) THEN CONCAT('âš ï¸ Fichaste TARDE la entrada de maÃ±ana. Hora programada: ', TIME_FORMAT(s.start_morning, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() LIMIT 1), '. Turno ABIERTO.') WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) >= s.end_morning AND TIME(NOW()) <= IFNULL(s.start_afternoon, TIME(NOW())) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_in IS NOT NULL )) THEN CONCAT('ðŸ”´ ERROR: No puedes fichar la SALIDA sin haber fichado la ENTRADA. Contacta con el administrador.') WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) <= IFNULL(s.start_afternoon, '23:59:59') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de MAÃ‘ANA. Hora programada: ', TIME_FORMAT(s.end_morning, '%H:%i'), '. Por favor, ficha la salida ahora.') WHEN (s.start_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_afternoon, '20:00:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL ) AND NOT EXISTS ( SELECT 1 FROM shifts sh2 WHERE sh2.user_id = u.id AND DATE(sh2.clock_in) = CURDATE() AND TIME(sh2.clock_in) >= s.start_afternoon )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de TARDE. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), '. Por favor, ficha ahora.') WHEN (s.start_afternoon IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) < s.start_afternoon )) THEN CONCAT('â„¹ï¸ Fichaste ANTES de tiempo la entrada de tarde. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), '. Turno ABIERTO.') WHEN (s.start_afternoon IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) > ADDTIME(s.start_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ Fichaste TARDE la entrada de tarde. Hora programada: ', TIME_FORMAT(s.start_afternoon, '%H:%i'), ' | Hora real: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon LIMIT 1), '. Turno ABIERTO.') WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) >= s.end_afternoon AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon ) AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL )) THEN CONCAT('ðŸ”´ ERROR: No puedes fichar la SALIDA de tarde sin haber fichado la ENTRADA de tarde. Contacta con el administrador.') WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de TARDE. Hora programada: ', TIME_FORMAT(s.end_afternoon, '%H:%i'), '. Por favor, ficha la salida ahora.') WHEN EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND ( (s.end_morning IS NOT NULL AND s.start_afternoon IS NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00')) OR (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00')) ) ) THEN CONCAT('ðŸ”´ Turno ABIERTO fuera de horario. Entrada: ', (SELECT TIME_FORMAT(TIME(clock_in), '%H:%i') FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL LIMIT 1), ' | Hora programada de salida: ', CASE WHEN s.start_afternoon IS NULL THEN TIME_FORMAT(s.end_morning, '%H:%i') ELSE TIME_FORMAT(s.end_afternoon, '%H:%i') END, '. Por favor, cierra el fichaje ahora.') ELSE NULL END AS mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = WEEKDAY(NOW()) + 1 WHERE u.active = 1 AND u.telegram_id IS NOT NULL;\n","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[608,720],"id":"bb0324a5-f597-4492-9693-7cddb9bf701e","name":"consulta antigua","credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-240,528],"id":"9fcb6e54-0ac4-4ffc-b912-e150a5471bce","name":"Telegram Trigger","webhookId":"f3c3f4fd-4930-413b-8131-fe637cb7d8ab","credentials":{"telegramApi":{"id":"BYsUD2vqRGd1zgnb","name":"Fichar Leon"}}},{"parameters":{"operation":"executeQuery","query":"SELECT tipo_aviso, id, name, telegram_id, hora_requerida, mensaje FROM ( SELECT 'FALTA_ENTRADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de maÃ±ana. Hora prevista: ', s.start_morning) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_morning, '-00:10:00') AND ADDTIME(s.start_morning, '00:12:00') ) UNION ALL SELECT 'FALTA_ENTRADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de tarde. Hora prevista: ', s.start_afternoon) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_afternoon, '-00:10:00') AND ADDTIME(s.start_afternoon, '00:12:00') ) UNION ALL SELECT 'ENTRADA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada maÃ±ana ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_morning, '-00:10:00') AND TIME(sh.clock_in) >= ADDTIME(s.start_morning, '-02:00:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 15 UNION ALL SELECT 'ENTRADA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada maÃ±ana CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:10:00') AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '02:00:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 15 UNION ALL SELECT 'ENTRADA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada tarde ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_afternoon, '-00:10:00') AND TIME(sh.clock_in) >= ADDTIME(s.start_afternoon, '-02:00:00') AND TIME(sh.clock_in) >= s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 15 UNION ALL SELECT 'ENTRADA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada tarde CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_afternoon, '00:10:00') AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '02:00:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 15 UNION ALL SELECT 'FALTA_SALIDA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de maÃ±ana. Hora prevista: ', s.end_morning) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) < s.end_morning AND TIME(NOW()) >= ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_morning, '02:00:00') UNION ALL SELECT 'FALTA_SALIDA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de tarde. Hora prevista: ', s.end_afternoon) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(NOW()) >= ADDTIME(s.end_afternoon, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_afternoon, '02:00:00') UNION ALL SELECT 'SALIDA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida maÃ±ana ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_in) < s.end_morning AND TIME(sh.clock_out) < ADDTIME(s.end_morning, '-00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 15 UNION ALL SELECT 'SALIDA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado salida maÃ±ana CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_in) < s.end_morning AND TIME(sh.clock_out) > ADDTIME(s.end_morning, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 15 UNION ALL SELECT 'SALIDA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida tarde ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_out) < ADDTIME(s.end_afternoon, '-00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 15 UNION ALL SELECT 'SALIDA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado salida tarde CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_out) > ADDTIME(s.end_afternoon, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 15 ) AS avisos ORDER BY tipo_aviso, hora_requerida;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[544,80],"id":"c77ba6c2-fb33-4884-95fd-fb336c0a37b0","name":"ultima antes de borrado","alwaysOutputData":true,"credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT tipo_aviso, id, name, telegram_id, hora_requerida, mensaje FROM ( SELECT 'FALTA_ENTRADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de maÃ±ana. Hora prevista: ', s.start_morning) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_morning, '-00:10:00') AND ADDTIME(s.start_morning, '00:12:00') ) UNION ALL SELECT 'FALTA_ENTRADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar ENTRADA de tarde. Hora prevista: ', s.start_afternoon) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND TIME(NOW()) >= ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) BETWEEN ADDTIME(s.start_afternoon, '-00:10:00') AND ADDTIME(s.start_afternoon, '00:12:00') ) UNION ALL SELECT 'ENTRADA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada maÃ±ana ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_morning, '-00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 UNION ALL SELECT 'ENTRADA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada maÃ±ana CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 UNION ALL SELECT 'ENTRADA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado entrada tarde ANTICIPADA (mÃ¡s de 10 min antes). Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) < ADDTIME(s.start_afternoon, '-00:10:00') AND TIME(sh.clock_in) >= s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 UNION ALL SELECT 'ENTRADA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada tarde CON RETRASO (mÃ¡s de 10 min tarde). Hora prevista: ', s.start_afternoon, ' | FichÃ³: ', TIME(sh.clock_in)) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_afternoon, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 UNION ALL SELECT 'FALTA_SALIDA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de maÃ±ana. Hora prevista: ', s.end_morning) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) < s.end_morning AND TIME(NOW()) >= ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_morning, '02:00:00') UNION ALL SELECT 'FALTA_SALIDA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ AVISO: Debe fichar SALIDA de tarde. Hora prevista: ', s.end_afternoon) as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(NOW()) >= ADDTIME(s.end_afternoon, '00:02:00') AND TIME(NOW()) < ADDTIME(s.end_afternoon, '02:00:00') UNION ALL SELECT 'SALIDA_ANTICIPADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida maÃ±ana ANTICIPADA. Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, sh.clock_out, s.end_morning), ' min antes') as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) < s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 UNION ALL SELECT 'SALIDA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado salida maÃ±ana CON RETRASO. Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_morning, sh.clock_out), ' min tarde') as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 UNION ALL SELECT 'SALIDA_ANTICIPADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('â„¹ï¸ Ha fichado salida tarde ANTICIPADA. Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, sh.clock_out, s.end_afternoon), ' min antes') as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) < s.end_afternoon AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 UNION ALL SELECT 'SALIDA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado salida tarde CON RETRASO. Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_afternoon, sh.clock_out), ' min tarde') as mensaje FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_afternoon AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 ) AS avisos ORDER BY tipo_aviso, hora_requerida;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[992,208],"id":"4d570a6a-b516-4b1a-83c4-773bdc7e8bc7","name":"funcionando despues de borrado","alwaysOutputData":true,"credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT IGNORE INTO avisos_enviados (user_id, tipo_aviso, shift_id, fecha_aviso, hora_aviso, hora_fichaje, mensaje) VALUES ({{ $json.user_id }}, '{{ $json.tipo_aviso }}', {{ $json.shift_id }}, CURDATE(), CURTIME(), '{{ $json.hora_requerida }}', '{{ $json.mensaje_sql }}');\n","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[960,544],"id":"4627bd8f-927d-43c0-9132-909b92fecec3","name":"guardar avisos","credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT u.name, av.tipo_aviso, av.fecha_aviso, av.hora_aviso, av.mensaje FROM avisos_enviados av INNER JOIN users u ON av.user_id = u.id WHERE av.fecha_aviso >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) ORDER BY av.created_at DESC;\n","options":{}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[864,720],"id":"4e319511-dd88-4e59-b589-ea25c716abb8","name":"historial de avisos","credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"jsCode":"const items = $input.all();\n\nreturn items.map(item => {\n  return {\n    json: {\n      user_id: item.json.id,  // Mapea 'id' a 'user_id'\n      tipo_aviso: item.json.tipo_aviso,\n      shift_id: item.json.shift_id || null,\n      fecha_aviso: new Date().toISOString().split('T')[0],\n      hora_aviso: new Date().toTimeString().split(' ')[0],\n      hora_fichaje: item.json.hora_requerida,  // Mapea 'hora_requerida' a 'hora_fichaje'\n      mensaje: (item.json.mensaje || '').replace(/'/g, \"''\")\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[848,352],"id":"2fb12df0-f150-4098-89c2-6e627235c2ea","name":"Code in JavaScript","disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT tipo_aviso, id, name, telegram_id, hora_requerida, mensaje, shift_id FROM ( SELECT 'ENTRADA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.start_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado entrada maÃ±ana CON RETRASO. Hora prevista: ', s.start_morning, ' | FichÃ³: ', TIME(sh.clock_in), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.start_morning, sh.clock_in), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.start_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) > ADDTIME(s.start_morning, '00:10:00') AND TIMESTAMPDIFF(MINUTE, sh.clock_in, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'ENTRADA_RETRASADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_RETRASADA_MANANA' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_morning as hora_requerida, CONCAT('âš ï¸ Ha fichado salida maÃ±ana CON RETRASO. Hora prevista: ', s.end_morning, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_morning, sh.clock_out), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_morning IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_morning AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_RETRASADA_MANANA' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) UNION ALL SELECT 'SALIDA_RETRASADA_TARDE' as tipo_aviso, u.id, u.name, u.telegram_id, s.end_afternoon as hora_requerida, CONCAT('âš ï¸ Ha fichado salida tarde CON RETRASO. Hora prevista: ', s.end_afternoon, ' | FichÃ³: ', TIME(sh.clock_out), ' | Diferencia: ', TIMESTAMPDIFF(MINUTE, s.end_afternoon, sh.clock_out), ' min tarde') as mensaje, sh.id as shift_id FROM users u INNER JOIN schedules s ON u.id = s.user_id INNER JOIN shifts sh ON u.id = sh.user_id WHERE s.dow = DAYOFWEEK(NOW()) - 1 AND s.end_afternoon IS NOT NULL AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) > TIME(sh.clock_in) AND TIME(sh.clock_out) > s.end_afternoon AND TIMESTAMPDIFF(MINUTE, sh.clock_out, NOW()) <= 30 AND NOT EXISTS ( SELECT 1 FROM avisos_enviados av WHERE av.user_id = u.id AND av.tipo_aviso = 'SALIDA_RETRASADA_TARDE' AND av.fecha_aviso = CURDATE() AND av.shift_id = sh.id ) ) AS avisos ORDER BY tipo_aviso, hora_requerida;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[1216,656],"id":"d68e7241-9a19-4d1b-b084-ade67323c3b6","name":"comprueba estado2","alwaysOutputData":true,"credentials":{"mySql":{"id":"GTfsGfSmUY7pTMfw","name":"MySQL account"}}},{"parameters":{"jsCode":"const items = $input.all();\n\nreturn items.map(item => {\n  // Escapar comillas simples para SQL\n  const mensajeEscapado = (item.json.mensaje || '')\n    .replace(/\\\\/g, '\\\\\\\\')  // Escapar backslashes\n    .replace(/'/g, \"\\\\'\");    // Escapar comillas simples\n  \n  return {\n    json: {\n      // Mantener datos originales para Telegram\n      telegram_id: item.json.telegram_id,\n      name: item.json.name,\n      mensaje_telegram: item.json.mensaje,\n      \n      // Datos preparados para INSERT\n      user_id: item.json.id,\n      tipo_aviso: item.json.tipo_aviso,\n      shift_id: item.json.shift_id || null,\n      hora_requerida: item.json.hora_requerida,\n      mensaje_sql: mensajeEscapado\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[688,592],"id":"ad0483a1-c869-4e4c-b78a-af2570884e4d","name":"Code in JavaScript1"}],"connections":{"comprueba estado":{"main":[[{"node":"Send a text message","type":"main","index":0},{"node":"Code in JavaScript1","type":"main","index":0}]]},"14:02":{"main":[[{"node":"comprueba estado","type":"main","index":0}]]},"9:32":{"main":[[{"node":"comprueba estado","type":"main","index":0}]]},"17:32":{"main":[[{"node":"comprueba estado","type":"main","index":0}]]},"20:02":{"main":[[{"node":"comprueba estado","type":"main","index":0}]]},"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"comprueba estado","type":"main","index":0}]]},"comprueba estado1":{"main":[[{"node":"Send a text message1","type":"main","index":0}]]},"Code in JavaScript1":{"main":[[{"node":"guardar avisos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2e4a6fde-16be-4a26-ba2e-839722d99b91","activeVersionId":null,"triggerCount":0,"shared":[{"updatedAt":"2026-01-08T12:52:32.475Z","createdAt":"2026-01-08T12:52:32.475Z","role":"workflow:owner","workflowId":"LV2eMVWMQtZ1wvH1OLxn5","projectId":"Grfgzkbo3T8PCQQA"}],"activeVersion":null,"tags":[]}