{"updatedAt":"2025-11-19T22:13:05.956Z","createdAt":"2025-11-19T22:13:05.956Z","id":"eGD14EYNN6YYBSjy","name":"Workflows para fichajes","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-720,512],"id":"31bf6429-5580-4a03-a6aa-2ee8d8630116","name":"When clicking â€˜Execute workflowâ€™"},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT u.name, u.telegram_id, s.dow AS dia_semana, CASE WHEN TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning THEN 'entrada_maÃ±ana' WHEN TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < s.start_afternoon THEN 'salida_maÃ±ana' WHEN TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon THEN 'entrada_tarde' WHEN TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') THEN 'salida_tarde' END AS tipo_fichaje_pendiente, CASE WHEN TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning THEN s.start_morning WHEN TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < s.start_afternoon THEN s.end_morning WHEN TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon THEN s.start_afternoon WHEN TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') THEN s.end_afternoon END AS hora_programada FROM schedules s INNER JOIN users u ON s.user_id = u.id WHERE s.dow = DAYOFWEEK(NOW()) AND u.active = 1 AND ( ( TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < s.end_morning AND s.start_morning IS NOT NULL AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') ) ) OR ( TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND TIME(NOW()) < IFNULL(s.start_afternoon, '23:59:59') AND s.end_morning IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_in IS NOT NULL ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) >= s.end_morning AND TIME(sh.clock_out) <= ADDTIME(s.end_morning, '00:15:00') ) ) OR ( TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < s.end_afternoon AND s.start_afternoon IS NOT NULL AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') ) ) OR ( TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND s.end_afternoon IS NOT NULL AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_in IS NOT NULL ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) >= s.end_afternoon AND TIME(sh.clock_out) <= ADDTIME(s.end_afternoon, '00:15:00') ) ) ) ORDER BY u.name;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-448,-160],"id":"c254b950-4388-4823-a618-8c6f3b0a928c","name":"comprueba estado1","alwaysOutputData":true,"credentials":{"mySql":{"id":"WAppnQbAh532E4XR","name":"MySQL account 2"}}},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"=TodavÃ­a no has fichado {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-176,-160],"id":"efc3ef64-aa90-4ea8-b8d9-0c451c434521","name":"Send a text message4","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}},{"parameters":{"operation":"executeQuery","query":"SELECT u.name, u.telegram_id, s.dow, CASE WHEN s.id IS NULL THEN 'No tienes horario asignado para hoy.' WHEN (s.start_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') )) THEN CONCAT('No has fichado la entrada de maÃ±ana. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_morning, '%H:%i')) WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) >= s.end_morning AND TIME(sh.clock_out) <= ADDTIME(s.end_morning, '00:15:00') )) THEN CONCAT('No has fichado la salida de maÃ±ana. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_morning, '%H:%i')) WHEN (s.start_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') )) THEN CONCAT('No has fichado la entrada de tarde. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_afternoon, '%H:%i')) WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_out) = CURDATE() AND TIME(sh.clock_out) >= s.end_afternoon AND TIME(sh.clock_out) <= ADDTIME(s.end_afternoon, '00:15:00') )) THEN CONCAT('No has fichado la salida de tarde. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_afternoon, '%H:%i')) ELSE 'Has fichado correctamente todas tus horas programadas hasta ahora.' END AS mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = DAYOFWEEK(NOW()) WHERE u.telegram_id = {{ $json.message.from.id }} AND u.active = 1 LIMIT 1;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-448,80],"id":"30436a23-0c30-41b0-817b-d0ca8491e5a6","name":"comprueba estado2","alwaysOutputData":true,"credentials":{"mySql":{"id":"WAppnQbAh532E4XR","name":"MySQL account 2"}}},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"=TodavÃ­a no has fichado {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-176,80],"id":"2bb930d9-24f7-49cd-84ce-5f79aed95ee8","name":"Send a text message6","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}},{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-720,80],"id":"2c3c3026-115c-4943-ac51-b74642672e5d","name":"Telegram Trigger","webhookId":"0f00d873-4893-4fdf-a4a2-e1d2afcb8a1e","credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}},{"parameters":{"operation":"executeQuery","query":"SELECT u.name, u.telegram_id, s.dow, CASE WHEN s.id IS NULL THEN 'No tienes horario asignado para hoy.' WHEN (s.start_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_morning, '23:59:59') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de MAÃ‘ANA. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_morning, '%H:%i')) WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND (s.start_afternoon IS NULL OR TIME(NOW()) < s.start_afternoon) AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.end_morning AND TIME(sh.clock_out) <= ADDTIME(s.end_morning, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de MAÃ‘ANA. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_morning, '%H:%i')) WHEN (s.start_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_afternoon, '23:59:59') AND (s.end_morning IS NULL OR EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL )) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de TARDE. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_afternoon, '%H:%i')) WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.end_afternoon AND TIME(sh.clock_out) <= ADDTIME(s.end_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de TARDE. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_afternoon, '%H:%i')) WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:15:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN 'ðŸ”´ Tienes un fichaje ABIERTO sin cerrar. Por favor, cierra el fichaje del dÃ­a.' WHEN (s.end_morning IS NOT NULL AND s.start_afternoon IS NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:15:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN 'ðŸ”´ Tienes un fichaje ABIERTO sin cerrar. Por favor, cierra el fichaje del dÃ­a.' ELSE 'âœ… Has fichado correctamente todas tus horas programadas hasta ahora.' END AS mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = DAYOFWEEK(NOW()) WHERE u.telegram_id = {{ $json.message.from.id }} AND u.active = 1 LIMIT 1;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-448,304],"id":"e07eebbe-f1d4-48b2-8e4b-f82a450c07f6","name":"comprueba estado3","alwaysOutputData":true,"credentials":{"mySql":{"id":"WAppnQbAh532E4XR","name":"MySQL account 2"}}},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"={{ $json.mensaje }} {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-176,304],"id":"eb9a00d0-20fa-45b1-8ec4-909c4e8cf0c4","name":"Send a text message7","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}},{"parameters":{"updates":["message"],"additionalFields":{}},"type":"n8n-nodes-base.telegramTrigger","typeVersion":1.2,"position":[-720,304],"id":"75579872-4d6f-471e-91c1-b3c17499d88a","name":"Telegram Trigger1","webhookId":"0f00d873-4893-4fdf-a4a2-e1d2afcb8a1e","credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}},{"parameters":{"operation":"executeQuery","query":"SELECT u.name, u.telegram_id, s.dow, CASE WHEN s.id IS NULL THEN 'No tienes horario asignado para hoy.' WHEN (s.start_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_morning, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_morning, '23:59:59') AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de MAÃ‘ANA. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_morning, '%H:%i')) WHEN (s.end_morning IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:02:00') AND (s.start_afternoon IS NULL OR TIME(NOW()) < s.start_afternoon) AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_morning AND TIME(sh.clock_in) <= ADDTIME(s.start_morning, '00:15:00') ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.end_morning AND TIME(sh.clock_out) <= ADDTIME(s.end_morning, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de MAÃ‘ANA. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_morning, '%H:%i')) WHEN (s.start_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.start_afternoon, '00:02:00') AND TIME(NOW()) < IFNULL(s.end_afternoon, '23:59:59') AND (s.end_morning IS NULL OR EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL )) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la ENTRADA de TARDE. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.start_afternoon, '%H:%i')) WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:02:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND TIME(sh.clock_in) >= s.start_afternoon AND TIME(sh.clock_in) <= ADDTIME(s.start_afternoon, '00:15:00') ) AND NOT EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NOT NULL AND TIME(sh.clock_out) >= s.end_afternoon AND TIME(sh.clock_out) <= ADDTIME(s.end_afternoon, '00:15:00') )) THEN CONCAT('âš ï¸ No has fichado la SALIDA de TARDE. DeberÃ­as haber fichado a las ', TIME_FORMAT(s.end_afternoon, '%H:%i')) WHEN (s.end_afternoon IS NOT NULL AND TIME(NOW()) > ADDTIME(s.end_afternoon, '00:15:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN 'ðŸ”´ Tienes un fichaje ABIERTO sin cerrar. Por favor, cierra el fichaje del dÃ­a.' WHEN (s.end_morning IS NOT NULL AND s.start_afternoon IS NULL AND TIME(NOW()) > ADDTIME(s.end_morning, '00:15:00') AND EXISTS ( SELECT 1 FROM shifts sh WHERE sh.user_id = u.id AND DATE(sh.clock_in) = CURDATE() AND sh.clock_out IS NULL )) THEN 'ðŸ”´ Tienes un fichaje ABIERTO sin cerrar. Por favor, cierra el fichaje del dÃ­a.' ELSE NULL END AS mensaje FROM users u LEFT JOIN schedules s ON s.user_id = u.id AND s.dow = DAYOFWEEK(NOW()) WHERE u.active = 1 AND u.telegram_id IS NOT NULL HAVING mensaje IS NOT NULL;\n","options":{"queryBatching":"independently"}},"type":"n8n-nodes-base.mySql","typeVersion":2.5,"position":[-448,512],"id":"bd194739-2e30-4b61-bea6-d3f576a98c6f","name":"comprueba estado4","alwaysOutputData":true,"credentials":{"mySql":{"id":"WAppnQbAh532E4XR","name":"MySQL account 2"}}},{"parameters":{"chatId":"={{ $json.telegram_id }}","text":"={{ $json.mensaje }} {{ $json.name }}","additionalFields":{"appendAttribution":false}},"type":"n8n-nodes-base.telegram","typeVersion":1.2,"position":[-176,512],"id":"dbc38ff6-c50c-42da-8049-421176eac32c","name":"Send a text message8","webhookId":"1166c9af-0403-480a-ada5-1bbc828abce6","notesInFlow":false,"credentials":{"telegramApi":{"id":"rcZje4ul5XIEpjwr","name":"Telegram FicharLeonBestHouse"}}}],"connections":{"When clicking â€˜Execute workflowâ€™":{"main":[[{"node":"comprueba estado4","type":"main","index":0}]]},"comprueba estado1":{"main":[[{"node":"Send a text message4","type":"main","index":0}]]},"comprueba estado2":{"main":[[{"node":"Send a text message6","type":"main","index":0}]]},"Telegram Trigger":{"main":[[{"node":"comprueba estado2","type":"main","index":0}]]},"comprueba estado3":{"main":[[{"node":"Send a text message7","type":"main","index":0}]]},"Telegram Trigger1":{"main":[[{"node":"comprueba estado3","type":"main","index":0}]]},"comprueba estado4":{"main":[[{"node":"Send a text message8","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"9cbb48d3-7d38-4d61-8023-66bd2a184ae6","triggerCount":0,"shared":[{"updatedAt":"2025-11-19T22:13:05.958Z","createdAt":"2025-11-19T22:13:05.958Z","role":"workflow:owner","workflowId":"eGD14EYNN6YYBSjy","projectId":"prlZ3bTXg0wKi0D1"}],"tags":[]}